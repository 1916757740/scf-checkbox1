name: 同步大佬代码并触发部署
on:
  schedule:
    - cron: '5 0,15 * * *'
  workflow_dispatch:

jobs:
  repo-sync:
    runs-on: ubuntu-latest
    env:
      PAT: ${{ secrets.PAT }}
      TG_USER_ID: ${{ secrets.TG_USER_ID }}
      TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
    steps:
      - uses: actions/checkout@v2
        with:
          repository: ${{ github.repository }}
          ref: master

      - name: sync lxk0301-scripts
        uses: repo-sync/github-sync@v2
        if: env.PAT
        with:
          source_repo: "https://github.com/lxk0301/jd_scripts.git"
          source_branch: "master"
          destination_branch: "master"
          github_token: ${{ env.PAT }}

      - name: 修改文件
        run: |
          sed -i \
          -e 's#//delete#delete#' \
          -e 's#//require(#require(#' \
          -e 's#      var request#//      var request#' \
          -e 's#      request(#//      request(#' \
          -e 's#        eval(#//        eval(#' \
          -e 's#      })#//      })#' \
          index.js

      - name: Add & Commit
        uses: EndBug/add-and-commit@v6.2.0
        with:
          token: ${{ env.PAT }}
          branch: 'master'

      - name: 触发部署到腾讯云函数
        if: env.PAT && github.event_name == 'schedule'  #只有定时任务才触发部署
        run: |
          curl \
            -X POST \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: token ${{ env.PAT }}" \
            -d '{"ref":"master"}' \
            https://api.github.com/repos/${{ github.repository }}/actions/workflows/deploy_tencent_scf.yml/dispatches

      - name: Notify To Telegram
        if: env.TG_USER_ID && env.TG_BOT_TOKEN
        run: |
          curl \
            -s -o /dev/null \
            -X POST \
            -H "Content-Type: application/json" \
            -d '{"text": "${{github.workflow}} 运行成功！","chat_id": "${{ env.TG_USER_ID }}"}' \
            https://api.telegram.org/bot${{ env.TG_BOT_TOKEN }}/sendMessage
